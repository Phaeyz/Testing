name: ~Lib~ Create Version Tag

on:
  workflow_call:
    inputs:
      breaking-change:
        required: true
        type: boolean
      new-feature:
        required: true
        type: boolean
    outputs:
      version:
        description: 'The created version tag.'
        value: ${{ jobs.create-version-tag.outputs.version }}

permissions:
  contents: write

jobs:
  create-version-tag:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.compute_version.outputs.version }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        filter: tree:0

    - name: Install MinVer CLI
      run: dotnet tool install --global minver-cli

    - name: Compute Version
      id: compute_version
      run: |
        if [ "$breaking-change" == "true" ]; then
          version=$(minver -v info -a major | tail -n 1)
        elif [ "$new-feature" == "true" ]; then
          version=$(minver -v info -a minor | tail -n 1)
        else
          version=$(minver -v info | tail -n 1)
        fi
        REGEX='^[0-9]+\.[0-9]+(\.[0-9]+)?'
        if [[ $version =~ $REGEX ]]; then
          version="${BASH_REMATCH[0]}"
        else
          version="0.0.0"
        fi
        echo "Computed version: $version"
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Create Git Tag
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version=${{ steps.compute_version.outputs.version }}
        git config --global user.name "Phaeyz"
        git config --global user.email "phaeyz@pm.me"
        git tag $version
        git push origin $version